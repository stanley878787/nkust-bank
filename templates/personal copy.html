{% load static %}
<!DOCTYPE html>
<html lang="zh-TW">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin="" />
  <link rel="stylesheet" as="style" onload="this.rel='stylesheet'"
    href="https://fonts.googleapis.com/css2?display=swap&amp;family=Inter%3Awght%40400%3B500%3B700%3B900&amp;family=Noto+Sans%3Awght%40400%3B500%3B700%3B900" />
  <title>高科銀行</title>
  <link rel="icon" type="image/x-icon" href="data:image/x-icon;base64," />
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="{% static 'style/personal.css' %}" />
  <link rel="stylesheet" href="{% static 'style/style.css' %}" />
</head>

<body>
  <header>
    <a href="{% url 'dashboard_page' %}" style="text-decoration: none;">
      <div class="logo-container">
        <div class="logo">
          <svg viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path
              d="M42.4379 44C42.4379 44 36.0744 33.9038 41.1692 24C46.8624 12.9336 42.2078 4 42.2078 4L7.01134 4C7.01134 4 11.6577 12.932 5.96912 23.9969C0.876273 33.9029 7.27094 44 7.27094 44L42.4379 44Z"
              fill="currentColor"></path>
          </svg>
        </div>
        <h2 class="brand-name">NKUST Bank</h2>
      </div>
    </a>

    <div class="nav-container">
      <div class="main-nav">
        <a class="nav-link" href="{% url 'dashboard_page' %}">帳務總覽</a>
        <a class="nav-link" href="{% url 'transfer_page' %}">轉帳</a>
        <a class="nav-link" href="{% url 'invest_page' %}">投資</a>
        <a class="nav-link" href="{% url 'recive_page' %}">明細查詢</a>
        <a class="nav-link" href="{% url 'personal_page' %}">個人資料</a>
        <a href="/login/" id="logoutBtn" class="btn-link">
          <button class="btn btn-secondary btn-md">
            <span class="btn-text">Log Out</span>
          </button>
        </a>
      </div>
    </div>
  </header>

  <!-- ========= 歡迎填寫畫面（預設顯示） ========= -->
  <div id="welcome-screen">
    <div class="content-container">
      <!-- 歡迎 Banner -->
      <div class="welcome-banner" id="welcome-banner">
        <div class="welcome-title">歡迎使用個人資料設定</div>
        <div class="welcome-text">請完成以下資料，讓我們更了解您</div>
      </div>

      <!-- 【新增】使用者姓名 -->
      <div class="settings-item" id="name-item">
        <div class="settings-content">
          <div class="settings-icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 24 24">
              <path d="M12 2a5 5 0 1 1 0 10a5 5 0 0 1 0-10zm0 12c-3.33 0-10 1.67-10 5v3h20v-3c0-3.33-6.67-5-10-5z" />
            </svg>
          </div>
          <div class="settings-text">
            <p class="settings-title">姓名</p>
            <p class="settings-description" id="name-display">
              <span class="empty-state">
                <svg xmlns="http://www.w3.org/2000/svg" width="16px" height="16px" fill="currentColor"
                  viewBox="0 0 256 256">
                  <path
                    d="M128,24A104,104,0,1,0,232,128,104.11,104.11,0,0,0,128,24Zm0,192a88,88,0,1,1,88-88A88.1,88.1,0,0,1,128,216Zm-8-80V80a8,8,0,0,1,16,0v56a8,8,0,0,1-16,0Zm20,36a12,12,0,1,1-12-12A12,12,0,0,1,140,172Z">
                  </path>
                </svg>
                尚未設定
              </span>
            </p>
          </div>
        </div>
        <button class="add-button" id="name-add-button">
          <svg xmlns="http://www.w3.org/2000/svg" width="16px" height="16px" fill="currentColor" viewBox="0 0 256 256">
            <path
              d="M224,128a8,8,0,0,1-8,8H136v80a8,8,0,0,1-16,0V136H40a8,8,0,0,1,0-16h80V40a8,8,0,0,1,16,0v80h80A8,8,0,0,1,224,128Z">
            </path>
          </svg>
          新增
        </button>
      </div>

      <!-- 電子郵件 -->
      <div class="settings-item" id="email-item">
        <div class="settings-content">
          <div class="settings-icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor"
              viewBox="0 0 256 256">
              <path
                d="M224,48H32a8,8,0,0,0-8,8V192a16,16,0,0,0,16,16H216a16,16,0,0,0,16-16V56A8,8,0,0,0,224,48ZM203.43,64,128,133.15,52.57,64ZM216,192H40V74.19l82.59,75.71a8,8,0,0,0,10.82,0L216,74.19V192Z">
              </path>
            </svg>
          </div>
          <div class="settings-text">
            <p class="settings-title">電子郵件</p>
            <p class="settings-description" id="email-display">
              <span class="empty-state">
                <svg xmlns="http://www.w3.org/2000/svg" width="16px" height="16px" fill="currentColor"
                  viewBox="0 0 256 256">
                  <path
                    d="M128,24A104,104,0,1,0,232,128,104.11,104.11,0,0,0,128,24Zm0,192a88,88,0,1,1,88-88A88.1,88.1,0,0,1,128,216Zm-8-80V80a8,8,0,0,1,16,0v56a8,8,0,0,1-16,0Zm20,36a12,12,0,1,1-12-12A12,12,0,0,1,140,172Z">
                  </path>
                </svg>
                尚未設定
              </span>
            </p>
          </div>
        </div>
        <button class="add-button" id="email-add-button">
          <svg xmlns="http://www.w3.org/2000/svg" width="16px" height="16px" fill="currentColor" viewBox="0 0 256 256">
            <path
              d="M224,128a8,8,0,0,1-8,8H136v80a8,8,0,0,1-16,0V136H40a8,8,0,0,1,0-16h80V40a8,8,0,0,1,16,0v80h80A8,8,0,0,1,224,128Z">
            </path>
          </svg>
          新增
        </button>
      </div>

      <!-- 資料完整度指示 -->
      <div class="completion-indicator" id="completion-indicator">
        <div class="completion-header">
          <div class="completion-title">資料完整度</div>
          <div class="completion-percentage" id="completion-percentage">0%</div>
        </div>
        <div class="progress-bar">
          <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- 成功動畫（隱藏） -->
  <div class="success-animation" id="success-animation">
    <svg class="checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
      <circle class="checkmark__circle" cx="26" cy="26" r="25" fill="none"></circle>
      <path class="checkmark__check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8"></path>
    </svg>
    <div class="success-text">設定完成！</div>
    <div class="success-subtext">正在載入您的個人資料...</div>
  </div>

  <!-- ===== 原本的 Header 與主選單等內容 ===== -->
  <div class="hidden" id="main-container">
    <div class="main-content">
      <!-- Main Content（原先的完整內容都放在這裡） -->
      <div class="content-container">
        <!-- 這裡是你原本顯示個人資料的部分 -->
        <div class="profile-header">
          <div class="avatar"></div>
          <div class="profile-info">
            <div class="name" id="profile-name">用戶姓名</div>
            <div class="role">User name</div>
          </div>
        </div>

        <!-- 行動電話 顯示，已經有 id="phone-display" 可動態更新 -->
        <div class="settings-item" id="phone-item">
          <div class="settings-content">
            <div class="settings-icon">
              <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor"
                viewBox="0 0 256 256">
                <path
                  d="M222.37,158.46l-47.11-21.11-.13-.06a16,16,0,0,0-15.17,1.4,8.12,8.12,0,0,0-.75.56L134.87,160c-15.42-7.49-31.34-23.29-38.83-38.51l20.78-24.71c.2-.25.39-.5.57-.77a16,16,0,0,0,1.32-15.06l0-.12L97.54,33.64a16,16,0,0,0-16.62-9.52A56.26,56.26,0,0,0,32,80c0,79.4,64.6,144,144,144a56.26,56.26,0,0,0,55.88-48.92A16,16,0,0,0,222.37,158.46ZM176,208A128.14,128.14,0,0,1,48,80,40.2,40.2,0,0,1,82.87,40a.61.61,0,0,0,0,.12l21,47L83.2,111.86a6.13,6.13,0,0,0-.57.77,16,16,0,0,0-1,15.7c9.06,18.53,27.73,37.06,46.46,46.11a16,16,0,0,0,15.75-1.14,8.44,8.44,0,0,0,.74-.56L168.89,152l47,21.05h0s.08,0,.11,0A40.21,40.21,0,0,1,176,208Z">
                </path>
              </svg>
            </div>
            <div class="settings-text">
              <p class="settings-title">行動電話</p>
              <p class="settings-description" id="phone-display">
                0987654322
              </p>
            </div>
          </div>
          <div class="settings-arrow">
            <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor"
              viewBox="0 0 256 256">
              <path
                d="M181.66,133.66l-80,80a8,8,0,0,1-11.32-11.32L164.69,128,90.34,53.66a8,8,0,0,1,11.32-11.32l80,80A8,8,0,0,1,181.66,133.66Z">
              </path>
            </svg>
          </div>
        </div>

        <!-- 電子郵件 -->
        <div class="settings-item" id="email-item-main">
          <div class="settings-content">
            <div class="settings-icon">
              <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor"
                viewBox="0 0 256 256">
                <path
                  d="M224,48H32a8,8,0,0,0-8,8V192a16,16,0,0,0,16,16H216a16,16,0,0,0,16-16V56A8,8,0,0,0,224,48ZM203.43,64,128,133.15,52.57,64ZM216,192H40V74.19l82.59,75.71a8,8,0,0,0,10.82,0L216,74.19V192Z">
                </path>
              </svg>
            </div>
            <div class="settings-text">
              <p class="settings-title">電子郵件</p>
              <p class="settings-description" id="email-main-item">
                --
              </p>
            </div>
          </div>
          <div class="settings-arrow">
            <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor"
              viewBox="0 0 256 256">
              <path
                d="M181.66,133.66l-80,80a8,8,0,0,1-11.32-11.32L164.69,128,90.34,53.66a8,8,0,0,1,11.32-11.32l80,80A8,8,0,0,1,181.66,133.66Z">
              </path>
            </svg>
          </div>
        </div>

        <!-- （以下保留其他未修改內容） -->
        <h3 class="section-title">安全性設定</h3>
        <div class="settings-item">
          <div class="settings-content">
            <div class="settings-icon">
              <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor"
                viewBox="0 0 256 256">
                <path
                  d="M48,56V200a8,8,0,0,1-16,0V56a8,8,0,0,1,16,0Zm92,54.5L120,117V96a8,8,0,0,0-16,0v21L84,110.5a8,8,0,0,0-5,15.22l20,6.49-12.34,17a8,8,0,1,0,12.94,9.4l12.34-17,12.34,17a8,8,0,1,0,12.94-9.4l-12.34-17,20-6.49A8,8,0,0,0,140,110.5Zm34,5.14a8,8,0,1,0,16,0V96a8,8,0,1,0-16,0Z">
                </path>
              </svg>
            </div>
            <div class="settings-text">
              <p class="settings-title">修改用戶代號及密碼</p>
              <p class="settings-description"></p>
            </div>
          </div>
          <div class="settings-arrow">
            <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor"
              viewBox="0 0 256 256">
              <path
                d="M181.66,133.66l-80,80a8,8,0,0,1-11.32-11.32L164.69,128,90.34,53.66a8,8,0,0,1,11.32-11.32l80,80A8,8,0,0,1,181.66,133.66Z">
              </path>
            </svg>
          </div>
        </div>

        <div class="settings-item">
          <div class="settings-content">
            <div class="settings-icon">
              <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor"
                viewBox="0 0 256 256">
                <path
                  d="M141.66,133.66l-40,40a8,8,0,0,1-11.32-11.32L116.69,136H24a8,8,0,0,1,0-16h92.69L90.34,93.66a8,8,0,0,1,11.32-11.32l40,40A8,8,0,0,1,141.66,133.66ZM200,32H136a8,8,0,0,0,0,16h56V208H136a8,8,0,0,0,0,16h64a8,8,0,0,0,8-8V40A8,8,0,0,0,200,32Z">
                </path>
              </svg>
            </div>
            <div class="settings-text">
              <p class="settings-title">近期登入紀錄</p>
              <p class="settings-description"></p>
            </div>
          </div>
          <div class="settings-arrow">
            <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor"
              viewBox="0 0 256 256">
              <path
                d="M181.66,133.66l-80,80a8,8,0,0,1-11.32-11.32L164.69,128,90.34,53.66a8,8,0,0,1,11.32-11.32l80,80A8,8,0,0,1,181.66,133.66Z">
              </path>
            </svg>
          </div>
        </div>

        <h3 class="section-title">通知設定</h3>
        <div class="settings-item">
          <div class="settings-content">
            <div class="settings-icon">
              <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor"
                viewBox="0 0 256 256">
                <path
                  d="M116,128a12,12,0,1,1,12,12A12,12,0,0,1,116,128ZM84,140a12,12,0,1,0-12-12A12,12,0,0,0,84,140Zm88,0a12,12,0,1,0-12-12A12,12,0,0,0,172,140Zm60-76V192a16,16,0,0,1-16,16H83l-32.6,28.16-.09.07A15.89,15.89,0,0,1,40,240a16.13,16.13,0,0,1-6.8-1.52A15.85,15.85,0,0,1,24,224V64A16,16,0,0,1,40,48H216A16,16,0,0,1,232,64ZM40,224h0ZM216,64H40V224l34.77-30A8,8,0,0,1,80,192H216Z">
                </path>
              </svg>
            </div>
            <div class="settings-text">
              <p class="settings-title">開啟／關閉簡訊 OTP</p>
              <p class="settings-description"></p>
            </div>
          </div>
          <div class="settings-arrow">
            <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor"
              viewBox="0 0 256 256">
              <path
                d="M181.66,133.66l-80,80a8,8,0,0,1-11.32-11.32L164.69,128,90.34,53.66a8,8,0,0,1,11.32-11.32l80,80A8,8,0,0,1,181.66,133.66Z">
              </path>
            </svg>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== 下面是 Modal 和 Toast 的部分，未修改 ===== -->
  <div class="modal" id="name-modal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title" id="name-modal-title">新增姓名</div>
        <button class="close-button" onclick="closeModal('name-modal')">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 256 256">
            <path
              d="M205.66,194.34a8,8,0,0,1-11.32,11.32L128,139.31,61.66,205.66a8,8,0,0,1-11.32-11.32L116.69,128,50.34,61.66A8,8,0,0,1,61.66,50.34L128,116.69l66.34-66.35a8,8,0,0,1,11.32,11.32L139.31,128Z">
            </path>
          </svg>
        </button>
      </div>
      <div class="form-group">
        <label class="form-label" for="first-name-input">姓</label>
        <input type="text" id="first-name-input" class="form-input" value="" placeholder="請輸入姓氏" />
      </div>
      <div class="form-group">
        <label class="form-label" for="last-name-input">名</label>
        <input type="text" id="last-name-input" class="form-input" value="" placeholder="請輸入名字" />
      </div>
      <button class="save-button" onclick="saveName()">儲存</button>
    </div>
  </div>

  <div class="modal" id="email-modal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title" id="email-modal-title">新增電子郵件</div>
        <button class="close-button" onclick="closeModal('email-modal')">
          <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256">
            <path
              d="M205.66,194.34a8,8,0,0,1-11.32,11.32L128,139.31,61.66,205.66a8,8,0,0,1-11.32-11.32L116.69,128,50.34,61.66A8,8,0,0,1,61.66,50.34L128,116.69l66.34-66.35a8,8,0,0,1,11.32,11.32L139.31,128Z">
            </path>
          </svg>
        </button>
      </div>
      <div class="form-group">
        <label class="form-label" for="email-input">電子郵件</label>
        <input type="email" id="email-input" class="form-input" value="" placeholder="請輸入電子郵件" />
      </div>
      <button class="save-button" onclick="saveEmail()">儲存</button>
    </div>
  </div>


  <!-- 行動電話 Modal -->
  <div class="modal" id="phone-modal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title" id="phone-modal-title">編輯行動電話</div>
        <button class="close-button" onclick="closeModal('phone-modal')">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor"
            viewBox="0 0 256 256">
            <path
              d="M205.66,194.34a8,8,0,0,1-11.32,11.32L128,139.31,61.66,205.66a8,8,0,0,1-11.32-11.32L116.69,128,50.34,61.66A8,8,0,0,1,61.66,50.34L128,116.69l66.34-66.35a8,8,0,0,1,11.32,11.32L139.31,128Z">
            </path>
          </svg>
        </button>
      </div>
      <div class="form-group">
        <label class="form-label" for="phone-input">行動電話</label>
        <input type="text" id="phone-input" class="form-input" value="" placeholder="請輸入行動電話" />
      </div>
      <button class="save-button" onclick="savePhone()">儲存</button>
    </div>
  </div>

  <!-- 電子郵件 Modal -->
  <div class="modal" id="main-email-modal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">修改電子郵件</div>
        <button class="close-button" onclick="closeModal('main-email-modal')">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 256 256">
            <path d="M205.66,194.34a8,8,0,0,1-11.32,11.32L128,139.31,61.66,205.66a8,8,0,0,1-11.32-11.32L116.69,128,50.34,61.66A8,8,0,0,1,61.66,50.34L128,116.69l66.34-66.35a8,8,0,0,1,11.32,11.32L139.31,128Z"></path>
          </svg>
        </button>
      </div>
      <div class="form-group">
        <label class="form-label" for="main-email-input">電子郵件</label>
        <input type="email" id="main-email-input" class="form-input" placeholder="請輸入電子郵件" />
      </div>
      <button class="save-button" onclick="saveMainEmail()">儲存</button>
    </div>
  </div>



  <div id="toast-container"></div>

  <!-- ===== JavaScript 部分 ===== -->
  <script>
    // =============== 新增：先在載入時呼叫 /personal/api/info/ ===============
    window.addEventListener('DOMContentLoaded', () => {
      const token = localStorage.getItem('accessToken');
      if (token) {
        fetch('/personal/api/info/', {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          }
        })
        .then(res => {
          if (!res.ok) throw new Error('無法取得個人資料');
          return res.json();
        })
        .then(data => {
          // 後端回傳：{ first_name, last_name, email, phone }
          const { first_name: givenName, last_name: familyName, email, phone } = data;

          // 將 fullName (姓 + 名) 填到 #name-display 與 #profile-name
          const fullName = (familyName || '') + (givenName || '');
          document.getElementById('name-display').textContent =
            (familyName || givenName) ? fullName : '尚未設定';
          document.getElementById('profile-name').textContent =
            (familyName || givenName) ? fullName : '用戶姓名';
          document.getElementById('email-main-item').textContent = email || '尚未設定';
          // 將 phone 填到 #phone-display
          document.getElementById('phone-display').textContent = phone || '尚未設定';

          // 更新按鈕狀態與 completionStatus
          if (familyName || givenName) {
            nameValues.family = familyName;
            nameValues.given  = givenName;
            completionStatus.name = true;
            document.getElementById('name-add-button').innerHTML = `
              <svg xmlns="http://www.w3.org/2000/svg" width="16px" height="16px" fill="currentColor" viewBox="0 0 256 256">
                <path d="M227.32,73.37,182.63,28.69a16,16,0,0,0-22.63,0L36.69,152A15.86,15.86,0,0,0,32,163.31V208a16,16,0,0,0,16,16H92.69A15.86,15.86,0,0,0,104,219.31L227.32,96a16,16,0,0,0,0-22.63ZM92.69,208H48V163.31l88-88L180.69,120ZM192,108.69,147.32,64l24-24L216,84.69Z"></path>
              </svg>
              編輯
            `;
          }

          if (email) {
            completionStatus.email = true;
            document.getElementById('email-add-button').innerHTML = `
              <svg xmlns="http://www.w3.org/2000/svg" width="16px" height="16px" fill="currentColor" viewBox="0 0 256 256">
                <path d="M227.32,73.37,182.63,28.69a16,16,0,0,0-22.63,0L36.69,152A15.86,15.86,0,0,0,32,163.31V208a16,16,0,0,0,16,16H92.69A15.86,15.86,0,0,0,104,219.31L227.32,96a16,16,0,0,0,0-22.63ZM92.69,208H48V163.31l88-88L180.69,120ZM192,108.69,147.32,64l24-24L216,84.69Z"></path>
              </svg>
              編輯
            `;
          }


          // 如果「姓名」「電子郵件」「行動電話」都不為空，就直接顯示主畫面
          if (familyName && givenName && email && phone) {
            transitionToMainContent();
            return;
          }

          // 否則顯示歡迎頁面，並更新進度條
          updateCompletionPercentage();
        })
        .catch(err => {
          console.error(err);
          // 若抓不到，就顯示歡迎頁或顯示錯誤訊息
        });
      }
    });

    // =============== 既有程式：追蹤完成狀態 ===============
    let completionStatus = {
      name: false,
      email: false,
    };

    // 存「姓」與「名」目前值 (family = last_name, given = first_name)
    let nameValues = {
      family: '',
      given: ''
    };

    // 更新進度條
    function updateCompletionPercentage() {
      const total = Object.keys(completionStatus).length;
      const completed = Object.values(completionStatus).filter(status => status).length;
      const percentage = Math.round((completed / total) * 100);
      document.getElementById('completion-percentage').textContent = `${percentage}%`;
      document.getElementById('progress-fill').style.width = `${percentage}%`;
      if (percentage === 100) {
        showSuccessAnimation();
      }
    }

    // 顯示成功動畫
    function showSuccessAnimation() {
      const successAnimation = document.getElementById('success-animation');
      successAnimation.classList.add('active');
      setTimeout(() => {
        successAnimation.classList.remove('active');
        transitionToMainContent();
      }, 3000);
    }

    // 切換到主畫面
    function transitionToMainContent() {
      document.getElementById('welcome-screen').classList.add('fade-out');
      setTimeout(() => {
        document.getElementById('welcome-screen').style.display = 'none';
        document.getElementById('main-container').classList.remove('hidden');
      }, 500);
    }

    // 打開/關閉 Modal
    function openModal(modalId) {
      document.getElementById(modalId).classList.add('active');
    }
    function closeModal(modalId) {
      document.getElementById(modalId).classList.remove('active');
    }

    // ============== 儲存姓名 ==============
    function saveName() {
      const token = localStorage.getItem('accessToken');
      if (!token) {
        showToast('請先登入', 'error');
        return;
      }
      // first-name-input 是「姓」，last-name-input 是「名」
      const family = document.getElementById('first-name-input').value.trim();
      const given  = document.getElementById('last-name-input').value.trim();
      if (!family || !given) {
        showToast('請輸入完整的姓與名', 'error');
        return;
      }
      fetch('/personal/api/info/', {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({
          first_name: given,    // 名 -> first_name
          last_name:  family    // 姓 -> last_name
        })
      })
      .then(res => {
        if (!res.ok) throw new Error('更新姓名失敗');
        return res.json();
      })
      .then(() => {
        nameValues.family = family;
        nameValues.given  = given;
        const fullName = family + given;
        // 更新 #name-display 和 #profile-name
        document.getElementById('name-display').textContent = fullName;
        document.getElementById('profile-name').textContent = fullName;
        completionStatus.name = true;
        updateCompletionPercentage();
        closeModal('name-modal');
        showToast('姓名已儲存', 'success');
        document.getElementById('name-add-button').innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" width="16px" height="16px" fill="currentColor" viewBox="0 0 256 256">
            <path d="M227.32,73.37,182.63,28.69a16,16,0,0,0-22.63,0L36.69,152A15.86,15.86,0,0,0,32,163.31V208a16,16,0,0,0,16,16H92.69A15.86,15.86,0,0,0,104,219.31L227.32,96a16,16,0,0,0,0-22.63ZM92.69,208H48V163.31l88-88L180.69,120ZM192,108.69,147.32,64l24-24L216,84.69Z"></path>
          </svg>
          編輯
        `;
      })
      .catch(err => {
        console.error(err);
        showToast('儲存姓名失敗，請稍後再試', 'error');
      });
    }

    // ============== 儲存電子郵件 ==============
    function saveEmail() {
      const token = localStorage.getItem('accessToken');
      if (!token) {
        showToast('請先登入', 'error');
        return;
      }
      const emailInput = document.getElementById('email-input').value.trim();
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailInput) {
        showToast('請輸入電子郵件', 'error');
        return;
      }
      if (!emailRegex.test(emailInput)) {
        showToast('請輸入有效的電子郵件格式', 'error');
        return;
      }
      fetch('/personal/api/info/', {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({
          email: emailInput
        })
      })
      .then(res => {
        if (!res.ok) throw new Error('更新電子郵件失敗');
        return res.json();
      })
      .then(() => {
        document.getElementById('email-display').textContent = emailInput;
        completionStatus.email = true;
        updateCompletionPercentage();
        closeModal('email-modal');
        showToast('電子郵件已儲存', 'success');
        document.getElementById('email-add-button').innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" width="16px" height="16px" fill="currentColor" viewBox="0 0 256 256">
            <path d="M227.32,73.37,182.63,28.69a16,16,0,0,0-22.63,0L36.69,152A15.86,15.86,0,0,0,32,163.31V208a16,16,0,0,0,16,16H92.69A15.86,15.86,0,0,0,104,219.31L227.32,96a16,16,0,0,0,0-22.63ZM92.69,208H48V163.31l88-88L180.69,120ZM192,108.69,147.32,64l24-24L216,84.69Z"></path>
          </svg>
          編輯
        `;
      })
      .catch(err => {
        console.error(err);
        showToast('儲存電子郵件失敗，請稍後再試', 'error');
      });
    }

    // ============== Toast 通知 ==============
    function showToast(message, type = 'info') {
      const toastContainer = document.getElementById('toast-container');
      const toast = document.createElement('div');
      toast.className = 'toast';
      if (type === 'error') {
        toast.style.background = '#b91c1c';
      } else if (type === 'success') {
        toast.style.background = '#15803d';
      }
      toast.textContent = message;
      toastContainer.appendChild(toast);
      setTimeout(() => toast.classList.add('show'), 10);
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => {
          toastContainer.removeChild(toast);
        }, 300);
      }, 2000);
    }

    // 綁定按鈕開啟 Modal
    document.getElementById('email-add-button').addEventListener('click', function (e) {
      e.stopPropagation();
      document.getElementById('email-modal-title').textContent = '編輯電子郵件';
      const currentEmail = document.getElementById('email-display').textContent.trim();
      document.getElementById('email-input').value =
        currentEmail === '尚未設定' ? '' : currentEmail;
      openModal('email-modal');
    });

    document.getElementById('name-add-button').addEventListener('click', function (e) {
      e.stopPropagation();
      document.getElementById('name-modal-title').textContent = '編輯姓名';
      // 把「姓（last_name）」放到 first-name-input，把「名（first_name）」放到 last-name-input
      document.getElementById('first-name-input').value = nameValues.family;  // 姓
      document.getElementById('last-name-input').value  = nameValues.given;   // 名
      openModal('name-modal');
    });

    document.getElementById('email-item').addEventListener('click', function () {
      openModal('email-modal');
    });
    document.getElementById('name-item').addEventListener('click', function () {
      openModal('name-modal');
    });



    // 綁定主畫面行動電話那一整塊可點擊，讓它打開 Phone Modal
    document.getElementById('phone-item').addEventListener('click', function (e) {
      e.stopPropagation();
      document.getElementById('phone-modal-title').textContent = '編輯行動電話';
      const currentPhone = document.getElementById('phone-display').textContent.trim();
      document.getElementById('phone-input').value =
        currentPhone === '尚未設定' ? '' : currentPhone;
      openModal('phone-modal');
    });

    // 綁定主畫面 Email 整個區塊點擊
    document.getElementById('email-item-main').addEventListener('click', function(e) {
      e.stopPropagation();
      // 把當前畫面顯示的 Email 塞進 modal input
      const currentEmail = document.getElementById('email-main-item').textContent.trim();
      document.getElementById('main-email-input').value = (currentEmail === '--' ? '' : currentEmail);
      openModal('main-email-modal');
    });


    // ============== 儲存行動電話 ==============
    function savePhone() {
      const token = localStorage.getItem('accessToken');
      if (!token) {
        showToast('請先登入', 'error');
        return;
      }

      // 1. 先拿現有畫面上顯示的電話
      const existingPhone = document.getElementById('phone-display').textContent.trim();

      // 2. 再拿使用者在 Modal 裡輸入的電話
      const phoneInput = document.getElementById('phone-input').value.trim();

      // 3. 如果兩者一樣，就顯示 Toast 提示，然後 return
      if (phoneInput === existingPhone) {
        showToast('行動電話未更改', 'error');
        return;
      }

      // 4. 格式驗證：必須 09 開頭 + 8 位數
      const phoneRegex = /^09\d{8}$/;
      if (!phoneInput) {
        showToast('請輸入行動電話', 'error');
        return;
      }
      if (!phoneRegex.test(phoneInput)) {
        showToast('請輸入正確的行動電話格式（例如 0912345678）', 'error');
        return;
      }

      // 5. 如果跟原本不一樣，就送出 PATCH
      fetch('/personal/api/info/', {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({ phone: phoneInput })
      })
        .then(res => {
          if (!res.ok) {
            return res.json().then(errData => {
              throw new Error(errData.detail || '更新行動電話失敗');
            });
          }
          return res.json();
        })
        .then(() => {
          // 更新成功：把主畫面上行動電話直接改成新值
          document.getElementById('phone-display').textContent = phoneInput;
          closeModal('phone-modal');
          showToast('行動電話已更新', 'success');
        })
        .catch(err => {
          console.error(err);
          showToast(err.message, 'error');
        });
    }

    // ============== 儲存電子郵件 ==============
    function saveMainEmail() {
      const token = localStorage.getItem('accessToken');
      if (!token) {
        showToast('請先登入', 'error');
        return;
      }

      // 1. 取得使用者在 Modal 裡輸入的 email
      const emailInput = document.getElementById('main-email-input').value.trim();

      // 2. 檢查是否為空
      if (!emailInput) {
        showToast('請輸入電子郵件', 'error');
        return;
      }

      // 3. 簡單正規驗證：xxx@yyy.zzz
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(emailInput)) {
        showToast('請輸入正確格式的電子郵件', 'error');
        return;
      }

      // 4. 送出 PATCH 請求更新 server
      fetch('/personal/api/info/', {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({ email: emailInput })
      })
      .then(res => {
        if (!res.ok) {
          // 如果後端回 409 或 400，body 裡面可能有 { "detail": "Email 已存在" } 之類
          return res.json().then(errData => {
            throw new Error(errData.detail || '更新電子郵件失敗');
          });
        }
        return res.json();
      })
      .then(data => {
        // 更新成功：把主畫面上的文字改成最新 email
        document.getElementById('email-main-item').textContent = emailInput;
        closeModal('main-email-modal');
        showToast('電子郵件已更新', 'success');
      })
      .catch(err => {
        console.error(err);
        showToast(err.message, 'error');
      });
    }

  </script>


</body>

</html>